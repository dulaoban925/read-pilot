# 功能规格说明：核心阅读体验

**功能分支**: `001-core-reading-experience`
**创建时间**: 2025-10-22
**状态**: 草稿
**输入**: 用户描述："核心阅读体验：实现基础文档处理流程（上传、提取、分块、嵌入）和基本 AI 交互（摘要和问答），使用户能够在 AI 辅助下阅读和理解文档"

## 用户场景与测试 *(必需)*

### 用户故事 1 - 文档上传和处理（优先级：P1）

用户可以上传支持格式的文档（PDF、EPUB、Markdown、DOCX），并将其处理为 AI 驱动的阅读辅助。系统提取文本，适当分块，并为语义搜索建立索引。

**为何设置此优先级**：这是基础能力 - 没有处理过的文档，其他功能都无法运作。它代表了最小可行产品，通过使文档准备好进行 AI 分析来提供即时价值。

**独立测试**：可以通过上传样本文档并验证以下内容进行完整测试：（1）上传成功完成，（2）文本正确提取，（3）文档显示在用户库中并包含正确的元数据，（4）处理完成且无错误。

**验收场景**：

1. **假设** 用户有一个小于 50MB 的 PDF 文档，**当** 他们通过拖放或文件浏览器上传文档时，**那么** 系统验证文件，显示上传进度，提取文本内容，并确认处理成功
2. **假设** 文档正在处理中，**当** 用户查看他们的文档库时，**那么** 系统显示处理状态（待处理/处理中/已完成/失败）并带有适当的视觉指示器
3. **假设** 用户上传了无效的文件格式，**当** 系统验证文件时，**那么** 系统拒绝上传并显示清晰的错误消息，指出支持的格式
4. **假设** 一个 100 页的 PDF 文档，**当** 系统处理它时，**那么** 文本提取在 30 秒内完成，文档可用于 AI 交互

---

### 用户故事 2 - AI 驱动的文档摘要（优先级：P2）

用户可以请求 AI 生成其上传文档的摘要，以快速了解关键点、见解和概念，而无需阅读整个文档。

**为何设置此优先级**：摘要为需要快速了解文档内容的用户提供即时价值。它独立有用，不需要完整的对话式问答系统。

**独立测试**：可以通过上传文档（使用用户故事 1），请求摘要，并验证以下内容进行完整测试：（1）摘要在 10 秒内生成，（2）摘要包括摘要、关键见解和主要概念，（3）摘要质量适合文档类型，（4）摘要被缓存以便快速检索。

**验收场景**：

1. **假设** 已处理的文档，**当** 用户点击"生成摘要"时，**那么** 系统在 10 秒内创建包含摘要、关键见解和主要概念的结构化摘要
2. **假设** 文档已有现有摘要，**当** 用户再次请求摘要时，**那么** 系统立即检索缓存的摘要而不重新生成
3. **假设** 用户查看摘要，**当** 他们想要更多或更少的细节时，**那么** 他们可以调整摘要深度（简要/详细）并接收适当定制的摘要
4. **假设** 不同的文档类型（技术、叙述、学术），**当** 生成摘要时，**那么** 系统调整摘要风格以匹配文档类型

---

### 用户故事 3 - 上下文感知问答（优先级：P3）

用户可以用自然语言提问文档内容，并接收准确的、带有源材料引用的上下文答案。系统在会话之间维护对话历史。

**为何设置此优先级**：问答能够深入探索超出摘要的文档内容。虽然有价值，但对于 MVP 不是必需的，因为用户已经可以使用摘要阅读和理解文档。

**独立测试**：可以通过上传文档，提出有关其内容的特定问题，并验证以下内容进行完整测试：（1）答案在 5 秒内生成，（2）答案在上下文上准确且相关，（3）源引用参考正确的页面/部分，（4）对话历史在页面刷新后保持，（5）后续问题保持上下文。

**验收场景**：

1. **假设** 已处理的文档，**当** 用户用自然语言提问时，**那么** 系统执行语义搜索，找到相关段落，在 5 秒内生成带引用的准确答案
2. **假设** 用户已经提出多个问题，**当** 他们查看对话时，**那么** 系统显示带时间戳的完整对话历史，并在会话之间保持上下文
3. **假设** 用户收到答案，**当** 系统生成响应时，**那么** 它包括引用特定页面或部分的源引用，显示信息来源
4. **假设** 对话正在进行中，**当** 用户提出后续问题时，**那么** 系统理解上下文并提供相关答案，而无需用户重复信息
5. **假设** 用户查看答案，**当** 系统有信心建议相关问题时，**那么** 它显示 2-3 个后续问题建议

---

### 边界情况

- 当文档的 OCR 质量差或扫描图像没有文本时会发生什么？
- 系统如何处理混合语言或特殊字符的文档？
- 当文档大小接近 50MB 限制时会发生什么？
- 当 AI 服务暂时不可用时，系统如何响应？
- 当用户上传似乎损坏或格式错误的文档时会发生什么？
- 系统如何处理在最大限制下的 1000+ 页文档？
- 当语义搜索没有返回用户问题的相关段落时会发生什么？
- 当对话历史超过存储限制时，系统如何管理？

## 需求 *(必需)*

### 功能需求

**文档管理**
- **FR-001**：系统必须接受 PDF、EPUB、Markdown 和 DOCX 格式的文档上传
- **FR-002**：系统必须在处理前验证文件格式和大小（每个文件最大 50MB）
- **FR-003**：系统必须验证每个文档的最大页数为 1000 页
- **FR-004**：系统必须安全存储上传的文档并具有适当的访问控制
- **FR-005**：系统必须在文件传输期间向用户显示上传进度
- **FR-006**：用户必须能够在库视图中查看其所有上传的文档
- **FR-007**：用户必须能够删除他们上传的文档
- **FR-008**：系统必须显示文档元数据（标题、文件类型、大小、页数、上传日期）

**文档处理**
- **FR-009**：系统必须从所有支持的文档格式中提取文本内容
- **FR-010**：系统必须将提取的文本分块为 500-1000 个 token（标记）的段落以实现高效处理
- **FR-011**：系统必须为文档块生成 vector embeddings（向量嵌入）并将其存储在 vector database（向量数据库）中
- **FR-012**：系统必须跟踪每个文档的处理状态（待处理、处理中、已完成、失败）
- **FR-013**：系统必须实时向用户显示处理状态
- **FR-014**：系统必须优雅地处理处理错误并提供清晰的错误消息
- **FR-015**：系统必须在 30 秒内完成 100 页文档的文本提取
- **FR-016**：系统必须异步处理文档而不阻塞用户交互

**摘要生成**
- **FR-017**：用户必须能够从文档视图请求文档摘要
- **FR-018**：系统必须生成包含三个组件的摘要：摘要、关键见解和主要概念
- **FR-019**：系统必须根据文档类型（技术、叙述、学术）调整摘要风格
- **FR-020**：用户必须能够调整摘要深度（简要或详细）
- **FR-021**：系统必须缓存生成的摘要以便快速检索
- **FR-022**：系统必须在 10 秒内为 10 页文档生成摘要
- **FR-023**：系统必须持久化摘要，使其在会话之间保持可用

**问答交互**
- **FR-024**：用户必须能够用自然语言提问文档内容
- **FR-025**：系统必须执行语义搜索以为每个问题找到相关的文档段落
- **FR-026**：系统必须基于检索的段落生成上下文答案
- **FR-027**：系统必须在答案中包含源引用（页码或部分）
- **FR-028**：系统必须在用户会话之间维护对话历史
- **FR-029**：系统必须在 5 秒内生成答案
- **FR-030**：系统必须在提供答案后建议 2-3 个相关的后续问题
- **FR-031**：系统必须为后续问题保留对话上下文
- **FR-032**：用户必须能够查看带时间戳的完整对话历史

**错误处理**
- **FR-033**：系统必须在文档上传失败时提供清晰、可操作的错误消息
- **FR-034**：系统必须在 AI 服务不可用时实现优雅降级
- **FR-035**：系统必须自动重试瞬态失败（使用指数退避）
- **FR-036**：系统必须记录所有处理错误以便故障排除

### 核心实体

- **Document（文档）**：表示具有元数据（标题、类型、大小、页数、字数）的上传文件，处理状态、文件存储位置和可选的缓存摘要。与 User（所有者）、ChatSessions（关于此文档的对话）和 ReadingHistory（使用跟踪）相关。

- **DocumentChunk（文档块）**：表示处理后的文档文本段（500-1000 个 tokens）及其 vector embeddings（向量嵌入）用于语义搜索。与 Document（父级）相关，包括块索引、内容、token 计数和 embedding vector（嵌入向量）。

- **ChatSession（聊天会话）**：表示用户与 AI 之间的对话，可选地限定在特定文档范围内。包含标题、创建时间戳和最后更新时间戳。与 User（所有者）、Document（可选上下文）和 Messages（对话内容）相关。

- **Message（消息）**：表示单个对话交换，包含角色（用户或助手）、内容文本、可选源引用和时间戳。与 ChatSession（父对话）相关。

- **Summary（摘要）**：表示缓存的 AI 生成文档摘要，包含组件（摘要、见解、概念）、深度级别（简要/详细）、生成时间戳和文档类型。与 Document（被摘要的内容）相关。

- **User（用户）**：表示具有身份验证凭据、偏好设置和元数据的系统用户。与 Documents（上传的文件）、ChatSessions（对话）和 ReadingHistory（活动跟踪）相关。

- **ReadingHistory（阅读历史）**：表示用户交互跟踪，包含文档标识符、花费时间、完成状态和时间戳。与 User（行为者）和 Document（内容）相关。

## 成功标准 *(必需)*

### 可衡量结果

**上传和处理性能**
- **SC-001**：用户可以在 5 秒内上传 10MB 文档
- **SC-002**：系统在 30 秒内从 100 页 PDF 中提取文本
- **SC-003**：95% 的文档上传在首次尝试时成功完成
- **SC-004**：用户在任何状态更改后 1 秒内收到有关处理状态的清晰反馈

**AI 交互质量**
- **SC-005**：系统在 10 秒内为 10 页文档生成文档摘要
- **SC-006**：系统在 5 秒内以相关响应回答用户问题
- **SC-007**：90% 的摘要请求从缓存中满足（即时检索）
- **SC-008**：用户在 70% 的情况下将 AI 生成的摘要评为有帮助或非常有帮助
- **SC-009**：85% 的问答响应包含准确的源引用

**用户体验**
- **SC-010**：用户可以在账户创建后 3 分钟内成功上传并阅读他们的第一个文档
- **SC-011**：80% 的用户在没有帮助的情况下成功完成核心工作流程（上传 → 摘要 → 提问）
- **SC-012**：对话历史在会话之间至少保持 90 天
- **SC-013**：系统在文档库浏览时保持响应式交互，时间少于 2 秒

**系统可靠性**
- **SC-014**：系统在 1000 个并发用户下处理而无性能下降
- **SC-015**：文档处理对支持格式的成功率超过 95%
- **SC-016**：当 AI 服务暂时不可用时，系统提供优雅降级（显示缓存数据，排队请求）
- **SC-017**：向量搜索在 95% 的查询中在 2 秒内返回相关结果

**可扩展性**
- **SC-018**：系统支持每个用户最多 10,000 个文档而无性能影响
- **SC-019**：系统在可接受的时间限制内处理最多 1000 页的文档
- **SC-020**：随着用户文档库的增长，存储和检索操作保持高效

## 假设 *(可选)*

- 用户具有可靠的互联网连接以进行文档上传和 AI 交互
- 文档主要是英语或中文（初始语言支持）
- 用户理解 AI 生成的内容可能偶尔包含不准确之处
- 文档内容是合法获得的，用户有权上传和处理它
- 大多数文档将是基于文本的（而不是主要是图像或扫描内容）
- 用户将主要通过桌面或平板电脑上的 Web 浏览器与文档交互
- AI 服务提供商（OpenAI、Anthropic）将保持合理的 API 可用性（>99% 正常运行时间）
- AI 服务的处理成本将保持在可接受的预算约束内
- 用户期望现代 Web 应用程序性能标准（低于 5 秒的响应时间）
- 文档格式符合标准（不是严重损坏或格式错误的）

## 依赖项 *(可选)*

**外部服务**
- OpenAI API 用于文本嵌入和 GPT-4 用于摘要/问答（主要 AI 提供商）
- Anthropic Claude API 作为 AI 能力的后备
- 文件存储服务（开发环境使用本地文件系统，生产环境使用 S3 兼容）
- PostgreSQL 用于主要数据持久化
- Redis 用于缓存和会话管理

**第三方库**
- PDF 处理：PyPDF2 或 pdfplumber 用于文本提取
- DOCX 处理：python-docx 用于 Word 文档解析
- EPUB 处理：ebooklib 用于电子书文本提取
- Markdown 处理：Python markdown 库
- Vector embeddings：sentence-transformers 用于生成嵌入
- Vector 存储：ChromaDB 用于语义搜索能力

**基础设施**
- 异步任务队列（Celery）用于后台文档处理
- 数据库迁移框架用于模式管理
- 身份验证和会话管理基础设施

## 范围之外 *(可选)*

以下功能明确不在此核心阅读体验的范围内，将在未来阶段考虑：

- 高级注释功能（高亮、书签、边注）
- 间隔重复学习和测验生成
- 文档关系的知识图谱可视化
- 多用户协作文档
- 实时协作阅读会话
- 原生移动应用程序（iOS/Android）
- 离线文档访问和处理
- 文档比较和差异功能
- 导出注释和笔记
- 与外部笔记应用程序集成（Notion、Evernote）
- 针对特定文档类型的自定义 AI 模型微调
- 文档翻译能力
- 文本转语音和音频文档播放
- 高级搜索过滤器和全文搜索（超出语义搜索）
- 文档集合和组织层次结构
