# API 响应标准化需求质量检查清单

**目的**: 验证 API 响应标准化的需求质量、完整性和一致性（事后验证 + 架构审查）
**创建时间**: 2025-10-23
**功能**: API 响应数据结构统一化
**相关文档**: [API_RESPONSE_STANDARD.md](../../../API_RESPONSE_STANDARD.md), [backend/app/schemas/response.py](../../../backend/app/schemas/response.py)

**使用场景**: 自检（作者）+ 架构评审（技术负责人）
**风险重点**: 向后兼容性、类型安全、错误处理完整性

---

## 需求完整性 (Requirement Completeness)

- [ ] CHK001 - 响应格式的三个核心字段（code, message, data）是否都有明确的语义定义和使用规则？ [完整性]
- [ ] CHK002 - 是否定义了所有标准 HTTP 状态码（0, 400, 401, 403, 404, 422, 500）对应的业务含义和使用场景？ [完整性]
- [ ] CHK003 - 分页响应的所有必需字段（items, total, page, page_size, total_pages）是否都有明确规范？ [完整性]
- [ ] CHK004 - 是否文档化了特殊场景的例外情况（文件下载、第三方回调、健康检查）？ [完整性]
- [ ] CHK005 - 前端 API 客户端的两种使用模式（标准方法 vs Raw 方法）是否都有完整说明？ [完整性]
- [ ] CHK006 - 是否定义了成功响应和错误响应的判断标准（code === 0 vs code !== 0）？ [完整性]
- [ ] CHK007 - 后端辅助函数（success, error, paginated_success）的参数要求是否完整定义？ [完整性]

## 需求清晰度 (Requirement Clarity)

- [ ] CHK008 - "code" 字段的取值规则是否明确（0=成功，非0使用HTTP状态码）？ [清晰度]
- [ ] CHK009 - "message" 字段的内容要求是否具体（例如：是面向用户还是开发者的消息）？ [清晰度，歧义]
- [ ] CHK010 - "data" 字段在成功和失败情况下的类型约束是否清楚（T | null）？ [清晰度]
- [ ] CHK011 - 分页字段命名是否与后端实际返回一致（total_pages vs pages）？ [清晰度]
- [ ] CHK012 - 前端"自动提取 data 字段"的行为是否有明确的技术说明？ [清晰度]
- [ ] CHK013 - 错误对象结构（ApiError）的三个字段（message, status, detail）的区别是否清楚定义？ [清晰度，歧义]
- [ ] CHK014 - "统一响应格式"的例外场景边界是否明确量化（哪些端点可以例外）？ [清晰度]

## 需求一致性 (Requirement Consistency)

- [ ] CHK015 - 前端 TypeScript 类型定义（ApiResponse<T>）与后端 Pydantic Schema（ApiResponse）是否完全对齐？ [一致性]
- [ ] CHK016 - 前端 PaginationData 类型与后端分页响应结构是否字段名和类型都一致？ [一致性]
- [ ] CHK017 - 响应码规范表中的 code 值是否与 HTTP 状态码保持一致？ [一致性]
- [ ] CHK018 - 全局异常处理器返回的 code 字段是否与统一规范一致（使用 HTTP 状态码）？ [一致性]
- [ ] CHK019 - 所有 API 端点的错误响应是否都遵循统一格式（通过全局异常处理器）？ [一致性]
- [ ] CHK020 - 前端错误处理的 err.message 是否与后端返回的 message 字段对应？ [一致性]

## 向后兼容性和迁移 (Backward Compatibility & Migration)

- [ ] CHK021 - 是否评估了现有 API 端点迁移到新格式的影响范围？ [Gap，兼容性]
- [ ] CHK022 - 是否定义了旧代码迁移的完整步骤（后端和前端）？ [完整性，迁移]
- [ ] CHK023 - 是否识别了不兼容的变更点（例如：response.data → response.data.data）？ [兼容性]
- [ ] CHK024 - 是否有回滚策略定义，如果新格式导致问题？ [Gap，恢复流程]
- [ ] CHK025 - 是否评估了客户端缓存影响（浏览器缓存旧格式响应）？ [Gap，边缘情况]
- [ ] CHK026 - 是否定义了渐进式迁移策略（可以共存旧格式和新格式）？ [Gap，迁移策略]
- [ ] CHK027 - 迁移过程中的数据一致性保证是否有定义？ [Gap，数据完整性]

## 类型安全和契约验证 (Type Safety & Contract Validation)

- [ ] CHK028 - 前端 TypeScript 泛型参数 <T> 的使用规则是否明确？ [清晰度，类型安全]
- [ ] CHK029 - 是否要求前端 API 调用必须指定泛型类型（类型安全最佳实践）？ [Gap，约束]
- [ ] CHK030 - 后端 Pydantic Schema 是否定义了字段验证规则（例如：code 的取值范围）？ [Gap，验证]
- [ ] CHK031 - 前后端响应格式不一致时的检测机制是否定义？ [Gap，契约验证]
- [ ] CHK032 - 是否要求 API 文档（OpenAPI/Swagger）同步更新响应格式？ [Gap，文档同步]
- [ ] CHK033 - 分页响应中数值字段的边界情况是否有类型约束（例如：page >= 1）？ [Gap，验证]
- [ ] CHK034 - 前端响应拦截器检查 code 字段的逻辑是否完整（处理 null/undefined）？ [Gap，健壮性]

## 错误处理完整性 (Error Handling Completeness)

- [ ] CHK035 - 是否定义了所有可能的错误场景（网络错误、业务错误、服务器错误）？ [完整性]
- [ ] CHK036 - 业务错误（code !== 0）和 HTTP 错误（非 2xx 状态码）的处理是否都有覆盖？ [完整性]
- [ ] CHK037 - 前端响应拦截器对 code !== 0 的处理是否正确（应该 reject）？ [完整性，正确性]
- [ ] CHK038 - 401 未授权错误的特殊处理（清除 token、重定向登录）是否定义清楚？ [完整性]
- [ ] CHK039 - 网络错误（无 response）的错误消息是否有明确规范？ [完整性]
- [ ] CHK040 - 是否定义了错误消息的国际化（i18n）策略？ [Gap，国际化]
- [ ] CHK041 - 并发请求错误处理是否有冲突（例如：多个 401 同时触发重定向）？ [Gap，并发场景]
- [ ] CHK042 - 超时错误的处理是否定义（前端设置了 30s 超时）？ [完整性]
- [ ] CHK043 - 服务端 500 错误是否暴露敏感信息（堆栈跟踪）？ [Gap，安全性]

## 场景覆盖 (Scenario Coverage)

### 主要场景

- [ ] CHK044 - 是否涵盖了单个资源获取的响应格式（GET /resource/{id}）？ [覆盖度]
- [ ] CHK045 - 是否涵盖了列表查询的分页响应格式（GET /resources）？ [覆盖度]
- [ ] CHK046 - 是否涵盖了资源创建的响应格式（POST /resources）？ [覆盖度]
- [ ] CHK047 - 是否涵盖了资源更新的响应格式（PUT/PATCH /resources/{id}）？ [覆盖度]
- [ ] CHK048 - 是否涵盖了资源删除的响应格式（DELETE /resources/{id}）？ [覆盖度]

### 边缘情况

- [ ] CHK049 - 空列表查询的响应格式是否定义（items: [], total: 0）？ [边缘情况]
- [ ] CHK050 - data 为 null 的合法场景是否明确（除了错误响应）？ [边缘情况]
- [ ] CHK051 - 超大分页请求的处理是否定义（page_size 上限）？ [边缘情况]
- [ ] CHK052 - 文件上传（multipart/form-data）的响应格式是否与标准一致？ [边缘情况]
- [ ] CHK053 - 流式响应（SSE/WebSocket）是否排除在标准格式之外？ [边缘情况，例外场景]
- [ ] CHK054 - 重复请求（幂等性）的响应格式是否一致？ [边缘情况]

### 异常和恢复场景

- [ ] CHK055 - 数据库连接失败时的响应格式是否定义？ [异常流程]
- [ ] CHK056 - AI 服务不可用时的降级响应是否定义？ [异常流程]
- [ ] CHK057 - Redis 缓存失败时的响应格式是否一致？ [异常流程]
- [ ] CHK058 - 请求超时时的错误响应格式是否统一？ [异常流程]

## 非功能性需求 (Non-Functional Requirements)

### 性能

- [ ] CHK059 - 响应格式的额外字段（code, message）是否评估了性能影响（带宽、序列化）？ [Gap，性能]
- [ ] CHK060 - 前端自动提取 data 的性能开销是否可接受？ [Gap，性能]
- [ ] CHK061 - 大数据量分页响应的性能是否有考虑（total 字段计算成本）？ [Gap，性能]

### 安全性

- [ ] CHK062 - 错误消息是否可能泄露敏感信息（例如：数据库结构）？ [Gap，安全]
- [ ] CHK063 - CORS 配置是否与响应格式统一性兼容？ [Gap，安全]
- [ ] CHK064 - 响应头是否包含安全相关头（X-Content-Type-Options 等）？ [Gap，安全]

### 可测试性

- [ ] CHK065 - 统一响应格式是否便于编写自动化测试？ [可测试性]
- [ ] CHK066 - 是否定义了测试辅助工具（mock 工具、fixture）？ [Gap，测试]
- [ ] CHK067 - 前端响应拦截器的单元测试策略是否定义？ [Gap，测试]

### 可维护性

- [ ] CHK068 - 响应格式变更的影响范围是否可控（通过类型系统）？ [可维护性]
- [ ] CHK069 - 是否有版本化策略（未来响应格式演进）？ [Gap，演进]
- [ ] CHK070 - API 文档生成是否自动化（从 Pydantic Schema）？ [Gap，文档]

## 依赖和假设 (Dependencies & Assumptions)

- [ ] CHK071 - 是否假设所有客户端都支持 JSON 解析？ [假设]
- [ ] CHK072 - 是否假设前端总是使用提供的 api 客户端（而非直接 axios）？ [假设]
- [ ] CHK073 - 后端全局异常处理器是否假设所有异常都可序列化为 JSON？ [假设]
- [ ] CHK074 - 是否依赖特定版本的 axios（拦截器行为）？ [依赖]
- [ ] CHK075 - 是否依赖特定版本的 FastAPI（异常处理机制）？ [依赖]
- [ ] CHK076 - 前端 localStorage 可用性假设是否验证（401 错误处理）？ [假设]

## 歧义和冲突 (Ambiguities & Conflicts)

- [ ] CHK077 - message 字段内容是中文还是英文？是否有多语言需求？ [歧义]
- [ ] CHK078 - code=0 的语义是否与某些业务场景冲突（例如：资源 ID 为 0）？ [冲突]
- [ ] CHK079 - 前端 err.message 和 err.detail 的使用场景区别是否清楚？ [歧义]
- [ ] CHK080 - "自动提取 data 字段"是否与某些需要访问 code/message 的场景冲突？ [冲突]
- [ ] CHK081 - 分页字段 page 是从 0 还是从 1 开始？前后端是否一致？ [歧义，一致性]
- [ ] CHK082 - Raw 方法的命名约定是否清楚（getRaw vs get_raw）？ [歧义]

## 可追溯性 (Traceability)

- [ ] CHK083 - 每个 API 端点是否都可追溯到响应格式规范？ [可追溯性]
- [ ] CHK084 - 迁移文档是否标识了所有修改的文件和代码行？ [可追溯性]
- [ ] CHK085 - 响应码规范是否与 HTTP RFC 标准对齐？ [可追溯性]
- [ ] CHK086 - 前端错误处理是否可追溯到后端异常类型？ [可追溯性]

---

## 验证总结

**总计**: 86 个检查项

**按类别分布**:
- 需求完整性: 7 项
- 需求清晰度: 7 项
- 需求一致性: 6 项
- 向后兼容性和迁移: 7 项
- 类型安全和契约验证: 7 项
- 错误处理完整性: 9 项
- 场景覆盖: 15 项（主要/边缘/异常场景）
- 非功能性需求: 9 项（性能/安全/可测试性/可维护性）
- 依赖和假设: 6 项
- 歧义和冲突: 7 项
- 可追溯性: 4 项

**使用说明**:
1. 逐项审查需求文档和实现代码
2. 对于标记 [Gap] 的项，评估是否需要补充需求
3. 对于标记 [歧义] 的项，澄清并更新文档
4. 对于标记 [冲突] 的项，解决冲突并统一规范
5. 优先处理与向后兼容性、类型安全、错误处理相关的高风险项

**关键风险项** (建议优先审查):
- CHK021-CHK027: 向后兼容性和迁移策略
- CHK028-CHK034: 类型安全和契约验证
- CHK035-CHK043: 错误处理完整性
- CHK059-CHK064: 性能和安全性
