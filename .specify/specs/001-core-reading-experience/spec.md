# Feature Specification: ReadPilot 核心功能

## Metadata

- **Feature ID**: 001-core-reading-experience
- **Feature Name**: ReadPilot 核心阅读体验
- **Owner**: Product Team
- **Created**: 2025-10-21
- **Status**: Draft
- **Priority**: P0 (MVP)
- **Target Release**: v1.0

---

## Product Vision & Context

**产品愿景**：让每个人都能拥有一个「懂自己、会共读」的 AI 伴读伙伴。

**产品定位**：融合「AI 阅读理解 + 智能对话 + 学习记录」的伴读工具。

**目标用户**：
- 学生：需要理解教材、论文、学习资料
- 知识工作者：需要快速消化行业报告、技术文档
- 教师：需要备课和教学辅助材料
- 企业培训人员：需要培训内容梳理和知识传递

**核心价值主张**：
1. 降低信息消化门槛 - 帮助用户快速理解复杂文档
2. 提升学习效率 - 自动生成摘要、测验与要点卡片
3. 构建知识记忆 - 记录用户的阅读偏好与薄弱点
4. 实现伴读体验 - 提供互动式阅读与问答支持

---

## User Stories & Scenarios

本规格遵循优先级驱动的用户故事格式，每个优先级的功能应该是**独立可测试**的。

### P1: 基础文档阅读与 AI 摘要生成

**描述**：用户能够上传文档，在阅读区查看内容，并通过 AI 自动生成文档摘要和重点提炼。

**优先级理由**：这是产品的最小可行版本（MVP）。没有文档展示和 AI 理解能力，产品的核心价值无法体现。此功能必须独立工作，为后续所有功能奠定基础。

**独立测试**：在没有对话功能、笔记功能的情况下，用户应该能够：
1. 上传一个 PDF 文档
2. 在阅读区看到正确渲染的文档内容
3. 点击"生成摘要"按钮后在 3 秒内看到 AI 生成的文档摘要
4. 看到自动提炼的 3-5 个核心要点

**验收场景 1.1：上传并阅读文档**

```gherkin
Given: 用户已打开 ReadPilot 应用
When: 用户点击"上传文档"按钮并选择一个 5MB 的 PDF 文件（《人工智能导论》第一章）
Then:
  - 文档在 2 秒内完成上传和解析
  - 阅读区正确显示文档内容，包括文字、图片、表格
  - 文档支持滚动浏览和缩放（50% - 200%）
  - 页面显示阅读进度条（当前页/总页数）
```

**验收场景 1.2：AI 自动生成摘要**

```gherkin
Given: 用户已成功上传并打开一个技术文档（10 页，约 8000 字）
When: 用户点击"生成摘要"按钮
Then:
  - 在 3 秒内，对话区显示 AI 生成的 300-500 字摘要
  - 摘要包含以下结构：
    - 文档主题（1 句话）
    - 核心论点（2-3 点）
    - 关键结论（1-2 点）
  - 摘要下方显示"重点提炼"卡片，包含 3-5 个要点
  - 每个要点不超过 50 字
```

**验收场景 1.3：重点定位与高亮**

```gherkin
Given: 用户已生成文档摘要和重点提炼
When: 用户点击某个"重点提炼"卡片
Then:
  - 阅读区自动滚动到该要点在原文中的位置
  - 原文中相关文本自动高亮显示（黄色背景）
  - 高亮在 3 秒后自动消失，或用户点击其他位置后消失
```

**边缘情况**：
- 文档格式不支持：显示友好错误提示"暂不支持该格式，请上传 PDF、EPUB 或 TXT 文件"
- 文档过大（> 50MB）：显示警告"文档较大，处理可能需要 10-30 秒"
- AI 服务不可用：显示"AI 服务暂时不可用，请稍后重试"并提供离线模式选项
- 空文档或无文本内容：显示"文档中未检测到可阅读文本"

---

### P2: 智能对话与引导式问答

**描述**：用户可以在对话区与 AI 进行互动式问答，AI 能够基于文档内容回答问题，并主动提出引导性问题帮助用户深入理解。

**优先级理由**：这是「伴读体验」的核心功能。P1 提供了基础的文档理解能力，P2 在此基础上增加互动性，让 AI 从「工具」升级为「伴侣」。此功能独立于笔记和学习记录，可以单独测试。

**依赖关系**：依赖 P1 的文档解析和 AI 理解能力。

**独立测试**：在 P1 功能可用的前提下，用户应该能够：
1. 在对话区输入问题并获得基于文档的回答
2. 看到 AI 主动提出的 3 个引导性问题
3. 选择某个引导性问题后获得深度解答

**验收场景 2.1：用户主动提问**

```gherkin
Given: 用户已上传并阅读一篇关于"机器学习"的文档
When: 用户在对话区输入问题"什么是监督学习？"
Then:
  - AI 在 2 秒内回复，答案基于文档内容
  - 回复中引用原文片段（显示为引用块）
  - 回复末尾显示"📖 查看原文"按钮，点击后跳转到文档中的相关位置
  - 如果文档中未提及相关内容，AI 回复"文档中未找到相关内容，以下是我的一般性回答："
```

**验收场景 2.2：AI 主动提出引导性问题**

```gherkin
Given: 用户完成文档摘要生成
When: 摘要显示完成
Then:
  - 对话区自动显示 AI 提出的 3 个引导性问题，例如：
    - "你想了解这篇文档中的哪个概念？"
    - "文中提到的方法论有哪些实际应用场景？"
    - "你认为作者的核心观点有哪些局限性？"
  - 问题以可点击的卡片形式展示
  - 用户点击某个问题后，AI 自动展开深度解答（200-300 字）
```

**验收场景 2.3：多轮对话与上下文记忆**

```gherkin
Given: 用户已与 AI 进行过 2 轮对话
When: 用户输入"那它和无监督学习有什么区别？"（没有明确指代对象）
Then:
  - AI 理解"它"指代上一轮讨论的"监督学习"
  - AI 回复比较监督学习和无监督学习的区别
  - 对话历史保持在对话区，可上下滚动查看
```

**边缘情况**：
- 问题超出文档范围：AI 明确说明"这个问题超出了当前文档的范围"并提供通用回答
- 问题模糊不清：AI 回复"你能更具体地描述问题吗？例如……"
- 对话历史过长（> 20 轮）：自动折叠历史消息，仅显示最近 10 轮

---

### P3: 阅读标注与笔记管理

**描述**：用户可以在阅读区对文档进行高亮、划线、批注，并在对话区查看和管理所有笔记。

**优先级理由**：这是「深度阅读」的重要功能，但不是 MVP 必需。P1 和 P2 已经提供了完整的阅读和理解体验，P3 是增强功能，帮助用户沉淀阅读成果。此功能独立于对话功能，可以单独测试。

**依赖关系**：依赖 P1 的文档展示能力。

**独立测试**：在 P1 功能可用的前提下，用户应该能够：
1. 选中文本后添加高亮或批注
2. 在笔记列表中查看所有标注
3. 点击笔记条目后跳转到原文位置

**验收场景 3.1：文本高亮标注**

```gherkin
Given: 用户正在阅读一篇文档
When: 用户用鼠标选中一段文本（"深度学习是机器学习的一个子集"）
Then:
  - 弹出标注工具栏，包含：
    - 🟡 高亮（黄色）
    - 🔴 重点（红色）
    - 📝 批注
    - ❌ 取消
  - 用户点击"高亮"后，文本背景变为黄色
  - 标注自动保存，刷新页面后仍然保留
```

**验收场景 3.2：添加批注笔记**

```gherkin
Given: 用户已选中一段文本
When: 用户点击"批注"按钮并输入"这段话需要进一步验证"
Then:
  - 原文旁边显示一个 📝 图标
  - 鼠标悬停在图标上时显示批注内容
  - 批注保存在笔记列表中，包含：
    - 批注内容
    - 原文片段（前后各 20 字）
    - 创建时间
    - 所在页码/章节
```

**验收场景 3.3：笔记列表与管理**

```gherkin
Given: 用户已在文档中添加了 5 个高亮和 3 个批注
When: 用户点击"笔记"标签页
Then:
  - 对话区切换为笔记列表视图
  - 列表按时间倒序显示所有笔记
  - 每个笔记条目包含：
    - 笔记类型图标（🟡 高亮 / 📝 批注）
    - 原文片段（最多 100 字）
    - 创建时间
    - "定位"按钮
  - 点击"定位"按钮后，阅读区跳转到该笔记的原文位置
```

**边缘情况**：
- 跨页选择：提示"暂不支持跨页标注，请分段标注"
- 图片区域标注：暂不支持，选中图片时工具栏不弹出
- 笔记数量过多（> 100 条）：分页显示，每页 20 条

---

### P4: 学习记录与个性化推荐

**描述**：系统记录用户的阅读历史、标注偏好、问答记录，并在用户中心展示学习轨迹、生成个性化的学习建议。

**优先级理由**：这是「持续进化」的关键功能，但需要积累一定的使用数据才能体现价值。P1-P3 已经提供完整的单次阅读体验，P4 是长期价值功能，帮助用户形成学习闭环。

**依赖关系**：依赖 P1-P3 的数据积累（阅读历史、标注、对话记录）。

**独立测试**：在用户已使用 P1-P3 功能至少 3 天后，应该能够：
1. 在用户中心看到阅读统计数据
2. 看到 AI 生成的个性化学习建议
3. 看到薄弱知识点提醒

**验收场景 4.1：阅读统计仪表盘**

```gherkin
Given: 用户已使用 ReadPilot 连续 7 天，阅读了 5 个文档，提问 30 次
When: 用户进入"用户中心"页面
Then:
  - 显示统计卡片：
    - 📚 累计阅读时长：8 小时 25 分钟
    - 📄 已阅读文档：5 份
    - 💬 提问次数：30 次
    - 📝 笔记数量：12 条
  - 显示阅读趋势图（近 7 天每日阅读时长）
  - 显示最常阅读的主题标签（如"机器学习" "深度学习" "算法"）
```

**验收场景 4.2：个性化学习建议**

```gherkin
Given: 系统已分析用户的阅读历史和问答记录
When: 用户进入"学习计划"标签页
Then:
  - AI 自动生成 3 条个性化建议，例如：
    - "你在'神经网络'相关内容上提问较多，建议深入阅读《深度学习入门》第 3 章"
    - "你最近阅读了 3 篇关于 NLP 的文档,建议整理一份主题笔记"
    - "你对'强化学习'的理解可能存在薄弱点，建议复习相关概念"
  - 每条建议包含"查看详情"按钮
  - 建议每周更新一次
```

**验收场景 4.3：薄弱知识点识别**

```gherkin
Given: 用户在某个知识点上反复提问但未标注重点
When: 系统检测到用户对"反向传播算法"提问 3 次，但相关内容无标注
Then:
  - 用户中心显示"薄弱知识点"提醒卡片
  - 提示"你似乎对'反向传播算法'还不够熟悉，建议重点复习"
  - 提供"生成测验"按钮，点击后生成 3 道相关选择题
  - 答题后显示正确率和解析
```

**边缘情况**：
- 新用户（使用 < 3 天）：显示"继续阅读以解锁个性化功能"
- 数据不足：显示"数据积累中，学习建议将在使用 3 天后生成"
- 隐私模式：用户可在设置中关闭学习记录功能

---

## Functional Requirements

以下需求按功能模块组织，使用 `FR-###` 格式编号。

### 文档处理模块

**FR-001**: 系统应支持上传以下格式的文档：PDF、EPUB、TXT、Markdown、DOCX（单个文件大小上限 50MB）

**FR-002**: 系统应在 2 秒内完成文档解析和内容提取（文件大小 < 10MB 时）

**FR-003**: 阅读区应正确渲染文档内容，包括文字、图片、表格、列表等元素

**FR-004**: 阅读区应支持以下交互操作：
- 滚动浏览（鼠标滚轮、触摸板、拖动滚动条）
- 缩放（50% - 200%，步长 10%）
- 全屏模式切换
- 跳转到指定页码

**FR-005**: 系统应自动保存用户的阅读进度（当前页码、滚动位置），下次打开时恢复

**FR-006**: 系统应支持同时打开多个文档，通过标签页切换

### AI 理解与生成模块

**FR-007**: 系统应在 3 秒内生成文档摘要（文档长度 < 10000 字时）

**FR-008**: 生成的摘要应包含以下结构：
- 文档主题（1 句话，不超过 50 字）
- 核心论点（2-5 点，每点不超过 100 字）
- 关键结论（1-3 点，每点不超过 80 字）

**FR-009**: 系统应自动提炼 3-5 个重点，每个重点不超过 50 字

**FR-010**: 重点提炼应支持"定位原文"功能，点击后跳转到相关段落并高亮

**FR-011**: 系统应在用户生成摘要后，自动生成 3 个引导性问题，帮助用户深入理解

**FR-012**: 系统应在 2 秒内响应用户的问答请求（问题长度 < 200 字时）

**FR-013**: AI 回答应基于文档内容，并引用原文片段（显示段落位置）

**FR-014**: 当问题超出文档范围时，AI 应明确说明并提供可选的通用回答

**FR-015**: 系统应支持多轮对话，记住上下文（保持最近 10 轮对话的上下文）

### 标注与笔记模块

**FR-016**: 用户选中文本后，应在 0.2 秒内弹出标注工具栏

**FR-017**: 标注工具栏应包含以下选项：
- 高亮（黄色）
- 重点标记（红色）
- 批注（弹出输入框）
- 取消

**FR-018**: 标注应立即保存到本地数据库，无需手动保存操作

**FR-019**: 批注应支持以下功能：
- 文本输入（最多 500 字）
- 编辑已有批注
- 删除批注

**FR-020**: 笔记列表应按时间倒序显示所有标注和批注

**FR-021**: 笔记条目应包含以下信息：
- 笔记类型（高亮/重点/批注）
- 原文片段（最多 100 字）
- 批注内容（如有）
- 创建时间
- 所在文档名称和页码

**FR-022**: 笔记列表应支持以下操作：
- 点击定位到原文
- 编辑批注
- 删除笔记
- 导出为 Markdown 或 PDF

### 学习记录模块

**FR-023**: 系统应记录以下用户行为数据：
- 每次阅读的开始和结束时间
- 阅读的文档 ID 和页码范围
- 提问的问题和 AI 回答
- 标注的位置和内容
- 生成的摘要和重点

**FR-024**: 用户中心应展示以下统计数据：
- 累计阅读时长（小时:分钟）
- 已阅读文档数量
- 提问次数
- 笔记数量
- 近 7 天阅读趋势图

**FR-025**: 系统应每周生成一次个性化学习建议（基于阅读主题、提问频率、标注行为）

**FR-026**: 系统应识别用户的薄弱知识点（连续提问 3 次以上且相关内容无标注的主题）

**FR-027**: 系统应支持生成自测测验（3-5 道选择题），基于文档内容和薄弱知识点

**FR-028**: 用户应能够在设置中关闭学习记录功能（进入隐私模式）

### 用户界面模块

**FR-029**: 应用界面应分为三个主要区域：
- 阅读区（左侧，占比 50-70%）
- 对话区（右侧，占比 30-50%）
- 顶部导航栏（包含文档切换、设置、用户中心入口）

**FR-030**: 对话区应支持以下视图切换：
- 对话视图（默认）
- 笔记列表视图
- 摘要与重点视图

**FR-031**: 应用应支持以下主题模式：
- 浅色模式
- 深色模式
- 自动跟随系统

**FR-032**: 应用应支持以下字体设置：
- 字体大小（12px - 32px，步长 2px）
- 字体族（系统默认、宋体、黑体、楷体）
- 行高（1.2 - 2.0，步长 0.2）

**FR-033**: 应用应支持键盘快捷键：
- `Ctrl/Cmd + O`: 打开文档
- `Ctrl/Cmd + F`: 搜索文档内容
- `Ctrl/Cmd + +/-`: 缩放阅读区
- `Ctrl/Cmd + Enter`: 发送对话消息
- `Esc`: 退出全屏模式

### 数据与隐私模块

**FR-034**: 所有用户数据应默认存储在本地（使用 SQLite 或 IndexedDB）

**FR-035**: 系统应支持可选的云同步功能（需用户明确授权）

**FR-036**: 用户应能够导出所有个人数据（包括笔记、标注、对话历史）为 JSON 或 ZIP 文件

**FR-037**: 用户应能够一键清除所有本地数据（包含二次确认）

**FR-038**: 如使用云端 AI 服务，应在首次使用前展示隐私声明并获得用户同意

**FR-039**: 系统应支持离线模式（使用本地 AI 模型），在网络不可用时自动切换

---

## Success Criteria

以下标准使用 `SC-###` 格式编号，必须**可量化且技术无关**。

### 用户体验指标

**SC-001**: 95% 的用户能够在首次使用时，在 3 次点击内完成文档上传并开始阅读

**SC-002**: 文档上传和解析的平均时间 < 2 秒（文件大小 < 10MB）

**SC-003**: AI 摘要生成的平均响应时间 < 3 秒（文档长度 < 10000 字）

**SC-004**: AI 问答的平均响应时间 < 2 秒（问题长度 < 200 字）

**SC-005**: 标注工具栏弹出的延迟 < 0.2 秒

**SC-006**: 应用界面操作的平均响应延迟 < 100ms

### 功能质量指标

**SC-007**: AI 生成的摘要准确性评分 ≥ 4.0/5.0（由 100 名用户评分）

**SC-008**: AI 问答的答案相关性 ≥ 85%（基于原文内容的回答比例）

**SC-009**: 文档内容渲染的准确率 ≥ 95%（与原始文档的视觉对比）

**SC-010**: 标注保存的成功率 ≥ 99.9%

**SC-011**: 阅读进度恢复的准确率 ≥ 99%（打开文档时定位到上次阅读位置）

### 用户留存指标

**SC-012**: 用户首周留存率 ≥ 60%

**SC-013**: 用户首月留存率 ≥ 40%

**SC-014**: 用户平均每周使用频率 ≥ 3 次

**SC-015**: 用户平均每次使用时长 ≥ 15 分钟

**SC-016**: 用户对产品的 NPS（净推荐值）≥ 40

### 性能与稳定性指标

**SC-017**: 应用崩溃率 < 0.1%（每 1000 次会话中崩溃 < 1 次）

**SC-018**: 应用内存占用 < 500MB（不含缓存的文档内容）

**SC-019**: 应用启动时间 < 3 秒（冷启动）

**SC-020**: 数据丢失率 < 0.01%（标注、笔记等数据）

### 可访问性指标

**SC-021**: 100% 的核心功能可通过键盘完成（不依赖鼠标）

**SC-022**: 通过 WCAG 2.1 AA 级可访问性测试（使用 axe DevTools 评分 ≥ 90/100）

**SC-023**: 屏幕阅读器可正确识别 ≥ 95% 的界面元素

### 学习效果指标

**SC-024**: 使用 ReadPilot 后，用户的阅读理解测试得分提升 ≥ 15%（对照实验）

**SC-025**: 80% 的用户认为 AI 生成的引导性问题"有助于深入理解"

**SC-026**: 用户在使用 ReadPilot 后，文档阅读速度提升 ≥ 20%（对照实验）

**SC-027**: 70% 的用户认为个性化学习建议"准确且有用"

---

## Non-Functional Requirements

### 性能要求

- 并发用户支持：系统应支持至少 10000 个并发用户（云版本）
- API 响应时间：95th percentile < 500ms
- 数据库查询时间：95th percentile < 100ms

### 安全要求

- 所有 API 请求必须经过身份验证（JWT Token）
- 用户密码必须使用 bcrypt 或 Argon2 加密存储
- 文件上传必须进行病毒扫描和格式校验
- 敏感操作（数据导出、删除）需要二次确认

### 兼容性要求

- 浏览器支持：Chrome 90+、Firefox 88+、Safari 14+、Edge 90+
- 操作系统：Windows 10+、macOS 11+、Ubuntu 20.04+
- 移动端：iOS 14+、Android 10+（响应式设计）

### 可维护性要求

- 代码覆盖率 ≥ 80%
- 所有公共 API 必须有文档注释
- 遵循 ESLint/Prettier 或 Black/Ruff 代码风格规范

---

## Out of Scope (Not in v1.0)

以下功能**不在 v1.0 范围内**，但可能在未来版本中考虑：

- ❌ 多人协作阅读（共享标注和笔记）
- ❌ 语音朗读功能（TTS）
- ❌ 视频和音频内容的 AI 分析
- ❌ 与 Notion、Obsidian 等笔记工具的集成
- ❌ 移动端原生应用（iOS/Android App）
- ❌ Chrome 浏览器插件（用于网页阅读）
- ❌ AI 生成思维导图或知识图谱
- ❌ 多语言翻译功能
- ❌ 企业级权限管理和用户组织

---

## Open Questions

以下问题需要在技术方案阶段解决：

1. **AI 模型选择**：使用云端 API（OpenAI GPT-4、Anthropic Claude）还是本地模型（Llama、Mistral）？
   - 云端模型质量更高但需联网且可能违反隐私原则
   - 本地模型隐私友好但需要用户有较强的硬件配置

2. **文档解析方案**：如何处理扫描版 PDF（需 OCR）？是否支持手写笔记识别？

3. **标注数据结构**：如何存储标注位置以应对文档格式转换（如 PDF 转 EPUB）？

4. **多设备同步**：如果用户选择云同步，如何处理冲突（如在两台设备上标注同一段落）？

5. **AI 成本控制**：如何平衡 AI 质量和 API 成本（尤其是免费用户）？是否设置每日调用次数限制？

6. **离线模式体验**：本地模型的质量是否足够支撑核心功能？如何提示用户切换到在线模式？

7. **数据隐私合规**：如果面向欧盟用户，如何确保 GDPR 合规？是否需要数据处理协议（DPA）？

---

## Dependencies & Risks

### 外部依赖

- **AI 服务提供商**：OpenAI、Anthropic 或本地 LLM 服务（Ollama、llama.cpp）
- **文档解析库**：PyMuPDF、pdf.js、ebooklib、python-docx
- **OCR 服务**（可选）：Tesseract、Google Cloud Vision API

### 风险评估

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| AI API 服务中断 | 中 | 高 | 提供离线模式备选方案 |
| 文档格式不兼容 | 高 | 中 | 明确支持格式列表，提供友好错误提示 |
| 用户数据丢失 | 低 | 高 | 实现自动备份和数据导出功能 |
| AI 回答质量不佳 | 中 | 高 | 提供反馈机制，持续优化 Prompt |
| 性能不达标 | 中 | 中 | 在开发阶段引入性能基准测试 |
| 隐私合规问题 | 低 | 高 | 默认本地存储，明确隐私声明 |

---

## Acceptance Testing Plan

### 测试策略

- **单元测试**：覆盖所有核心业务逻辑（目标覆盖率 80%）
- **集成测试**：测试 AI 服务、文档解析、数据库交互
- **端到端测试**：模拟用户完整使用流程（上传→阅读→提问→标注）
- **性能测试**：使用 Lighthouse、JMeter 进行性能基准测试
- **可访问性测试**：使用 axe DevTools 和屏幕阅读器进行测试

### 测试场景示例

**E2E 测试场景：新用户首次使用完整流程**

```
1. 启动应用（测量启动时间）
2. 点击"上传文档"并选择 sample.pdf
3. 验证文档在 2 秒内加载完成
4. 点击"生成摘要"按钮
5. 验证摘要在 3 秒内显示
6. 点击某个重点卡片
7. 验证阅读区跳转到正确位置并高亮
8. 在对话区输入问题"这篇文档的主要观点是什么？"
9. 验证 AI 在 2 秒内回答
10. 选中阅读区的一段文字
11. 点击"高亮"按钮
12. 验证高亮立即生效
13. 刷新页面
14. 验证阅读进度和高亮保留
```

---

## Glossary

- **伴读体验**：AI 不仅被动回答问题，还主动提出引导性问题，像真人一样陪伴用户阅读
- **重点提炼**：从文档中自动提取的关键信息点（Key Takeaways）
- **引导性问题**：AI 基于文档内容主动生成的问题，帮助用户深入思考
- **薄弱知识点**：系统识别出的用户理解不足的概念（基于提问频率和标注行为）
- **学习轨迹**：用户的阅读历史、提问记录、标注行为的时间线视图

---

## References & Related Documents

- [宪章文档](./.specify/memory/constitution.md) - 项目核心原则和技术约束
- [产品愿景文档](../../docs/product-vision.md) - 详细的产品定位和市场分析
- [技术选型对比](../../docs/tech-stack-comparison.md) - AI 模型和文档解析方案对比

---

**Status**: 本规格已完成初稿，待进一步审查和技术方案验证。

**Next Steps**:
1. 使用 `/speckit.plan` 命令生成技术实现方案
2. 评估 AI 模型选择和文档解析方案
3. 解决"Open Questions"中的待定问题
4. 进行宪章合规性检查
