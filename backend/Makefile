# ReadPilot Backend Makefile
# å¿«æ·å‘½ä»¤å·¥å…·

.PHONY: help install dev prod test lint format clean db-init db-migrate db-upgrade

help:
	@echo "ReadPilot Backend - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@echo "  make install     - å®‰è£…ä¾èµ–"
	@echo "  make dev         - å¯åŠ¨å¼€å‘æœåŠ¡å™¨ (çƒ­é‡è½½)"
	@echo "  make prod        - å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨"
	@echo "  make test        - è¿è¡Œæµ‹è¯•"
	@echo "  make lint        - ä»£ç æ£€æŸ¥"
	@echo "  make format      - ä»£ç æ ¼å¼åŒ–"
	@echo "  make clean       - æ¸…ç†ç¼“å­˜æ–‡ä»¶"
	@echo "  make db-init     - åˆå§‹åŒ–æ•°æ®åº“"
	@echo "  make db-migrate  - åˆ›å»ºæ•°æ®åº“è¿ç§»"
	@echo "  make db-upgrade  - åº”ç”¨æ•°æ®åº“è¿ç§»"
	@echo "  make diagnose    - è¯Šæ–­æœåŠ¡çŠ¶æ€"
	@echo "  make celery      - å¯åŠ¨ Celery Worker"
	@echo "  make celery-flower - å¯åŠ¨ Celery Flower ç›‘æ§é¢æ¿"
	@echo "  make celery-purge - æ¸…ç©º Celery ä»»åŠ¡é˜Ÿåˆ—"
	@echo "  make celery-inspect - æŸ¥çœ‹ Celery Worker çŠ¶æ€"
	@echo "  make celery-stats - æŸ¥çœ‹ Celery ç»Ÿè®¡ä¿¡æ¯"
	@echo ""

install:
	@echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
	poetry install

dev:
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "ğŸš€ å¯åŠ¨ ReadPilot Backend å¼€å‘æœåŠ¡å™¨..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "ğŸ“¡ æœåŠ¡åœ°å€:"
	@echo "   ğŸ  ä¸»é¡µ:        http://localhost:8000/"
	@echo "   â¤ï¸  å¥åº·æ£€æŸ¥:    http://localhost:8000/health"
	@echo "   ğŸ“š Swagger UI:  http://localhost:8000/docs"
	@echo "   ğŸ“– ReDoc:       http://localhost:8000/redoc"
	@echo "   ğŸ”§ OpenAPI:     http://localhost:8000/api/v1/openapi.json"
	@echo ""
	@echo "âš¡ çƒ­é‡è½½å·²å¯ç”¨ - ä»£ç ä¿®æ”¹åè‡ªåŠ¨é‡å¯"
	@echo "ğŸ›‘ æŒ‰ Ctrl+C åœæ­¢æœåŠ¡å™¨"
	@echo ""
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@poetry run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

prod:
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "ğŸš€ å¯åŠ¨ ReadPilot Backend ç”Ÿäº§æœåŠ¡å™¨..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "ğŸ“¡ æœåŠ¡åœ°å€:"
	@echo "   ğŸ  ä¸»é¡µ:        http://localhost:8000/"
	@echo "   â¤ï¸  å¥åº·æ£€æŸ¥:    http://localhost:8000/health"
	@echo "   ğŸ“š Swagger UI:  http://localhost:8000/docs"
	@echo "   ğŸ“– ReDoc:       http://localhost:8000/redoc"
	@echo ""
	@echo "âš™ï¸  Workers: 4"
	@echo "ğŸ›‘ æŒ‰ Ctrl+C åœæ­¢æœåŠ¡å™¨"
	@echo ""
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4

test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	pytest app/tests/ -v

test-watch:
	@echo "ğŸ§ª æµ‹è¯•ç›‘è§†æ¨¡å¼..."
	pytest-watch app/tests/ -v

lint:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	ruff check app/

format:
	@echo "ğŸ¨ ä»£ç æ ¼å¼åŒ–..."
	ruff format app/
	@echo "âœ… æ ¼å¼åŒ–å®Œæˆ!"

type-check:
	@echo "ğŸ” ç±»å‹æ£€æŸ¥..."
	mypy app/

clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼“å­˜..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".ruff_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	@echo "âœ… æ¸…ç†å®Œæˆ!"

db-init:
	@echo "ğŸ—„ï¸  åˆå§‹åŒ–æ•°æ®åº“ (åˆ›å»ºæ‰€æœ‰è¡¨)..."
	@python3 -c "import asyncio; from app.db.session import init_db; asyncio.run(init_db())" && echo "âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ!"

db-migrate:
	@echo "ğŸ—„ï¸  åˆ›å»ºæ•°æ®åº“è¿ç§»..."
	@read -p "è¿ç§»æ¶ˆæ¯: " message; \
	alembic revision --autogenerate -m "$$message"

db-upgrade:
	@echo "â¬†ï¸  åº”ç”¨æ•°æ®åº“è¿ç§»..."
	alembic upgrade head && echo "âœ… è¿ç§»å®Œæˆ!"

db-downgrade:
	@echo "â¬‡ï¸  å›æ»šæ•°æ®åº“è¿ç§»..."
	alembic downgrade -1 && echo "âœ… å›æ»šå®Œæˆ!"

db-history:
	@echo "ğŸ“œ æŸ¥çœ‹è¿ç§»å†å²..."
	alembic history

db-current:
	@echo "ğŸ“ å½“å‰æ•°æ®åº“ç‰ˆæœ¬..."
	alembic current

db-reset:
	@echo "âš ï¸  é‡ç½®æ•°æ®åº“ (åˆ é™¤æ‰€æœ‰æ•°æ®)..."
	@read -p "ç¡®è®¤åˆ é™¤æ‰€æœ‰æ•°æ®? [y/N]: " confirm; \
	if [ "$$confirm" = "y" ]; then \
		alembic downgrade base && alembic upgrade head && echo "âœ… æ•°æ®åº“å·²é‡ç½®!"; \
	else \
		echo "âŒ æ“ä½œå·²å–æ¶ˆ"; \
	fi

# Redis ç›¸å…³å‘½ä»¤
redis-cli:
	@echo "ğŸ”´ è¿æ¥ Redis CLI..."
	redis-cli

redis-ping:
	@echo "ğŸ”´ æµ‹è¯• Redis è¿æ¥..."
	@redis-cli ping && echo "âœ… Redis è¿æ¥æ­£å¸¸!"

redis-flush:
	@echo "âš ï¸  æ¸…ç©º Redis ç¼“å­˜..."
	@read -p "ç¡®è®¤æ¸…ç©ºæ‰€æœ‰ç¼“å­˜? [y/N]: " confirm; \
	if [ "$$confirm" = "y" ]; then \
		redis-cli FLUSHALL && echo "âœ… ç¼“å­˜å·²æ¸…ç©º!"; \
	else \
		echo "âŒ æ“ä½œå·²å–æ¶ˆ"; \
	fi

# æµ‹è¯•åŸºç¡€è®¾æ–½
test-setup:
	@echo "ğŸ§ª æµ‹è¯• Phase 1 åŸºç¡€è®¾æ–½..."
	python3 scripts/test_setup.py

# Docker ç›¸å…³å‘½ä»¤
docker-build:
	@echo "ğŸ³ æ„å»º Docker é•œåƒ..."
	docker build -t readpilot-backend .

docker-run:
	@echo "ğŸ³ è¿è¡Œ Docker å®¹å™¨..."
	docker run -p 8000:8000 readpilot-backend

docker-compose-up:
	@echo "ğŸ³ å¯åŠ¨ Docker Compose..."
	docker-compose up -d

docker-compose-down:
	@echo "ğŸ³ åœæ­¢ Docker Compose..."
	docker-compose down

# å¥åº·æ£€æŸ¥
health:
	@echo "â¤ï¸  æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
	@curl -s http://localhost:8000/health | python3 -m json.tool || echo "âŒ æœåŠ¡æœªè¿è¡Œ"

# Celery ç›¸å…³å‘½ä»¤
celery:
	@echo "âš™ï¸  å¯åŠ¨ Celery Worker..."
	@./start_celery.sh

celery-flower:
	@echo "ğŸŒ¸ å¯åŠ¨ Celery Flower ç›‘æ§é¢æ¿..."
	@echo "ğŸ“Š è®¿é—®åœ°å€: http://localhost:5555"
	@poetry run celery -A app.tasks.celery_app flower --port=5555

celery-purge:
	@echo "âš ï¸  æ¸…ç©º Celery ä»»åŠ¡é˜Ÿåˆ—..."
	@read -p "ç¡®è®¤æ¸…ç©ºæ‰€æœ‰å¾…å¤„ç†ä»»åŠ¡? [y/N]: " confirm; \
	if [ "$$confirm" = "y" ]; then \
		poetry run celery -A app.tasks.celery_app purge -f && echo "âœ… ä»»åŠ¡é˜Ÿåˆ—å·²æ¸…ç©º!"; \
	else \
		echo "âŒ æ“ä½œå·²å–æ¶ˆ"; \
	fi

celery-inspect:
	@echo "ğŸ” æŸ¥çœ‹ Celery Worker çŠ¶æ€..."
	@poetry run celery -A app.tasks.celery_app inspect active

celery-stats:
	@echo "ğŸ“Š æŸ¥çœ‹ Celery ç»Ÿè®¡ä¿¡æ¯..."
	@poetry run celery -A app.tasks.celery_app inspect stats

diagnose:
	@echo "ğŸ” è¯Šæ–­æœåŠ¡çŠ¶æ€..."
	@./diagnose.sh
